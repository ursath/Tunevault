<!DOCTYPE html>
<html>
    <head>
        {% load static %}
        <link rel="stylesheet" type="text/css" href="{% static 'vault.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'commentBox.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'post.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'globals.css' %}">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    </head>
    <body>
        <div class="Back">
            {% include 'NavBar.html' %}
            <div class="vault">
                <button id="goBack" class="back-button">
                    <i class="material-icons">arrow_back_ios</i>
                    <p>Back to vault</p>
                </button>

                <div class="post">
                    <img class="image" height="40" width="40" src="https://us.123rf.com/450wm/thesomeday123/thesomeday1231709/thesomeday123170900021/85622928-icono-de-perfil-de-avatar-predeterminado-marcador-de-posici%C3%B3n-de-foto-gris-vectores-de.jpg">
                    <div class="comment">
                        <div class="comment-header">
                            <h4 class="comment-title">@{{ post.user }}</h4>
                            <p class="date">{{ post.date }}</p>
                        </div>
                        <p class="post-comment">{{post.title}}</p>
                    </div>
                    <div class="post-likes-thumb">
                        <p>4</p>
                        <i onclick="toggleThumb(this)" class="material-icons thumb">thumb_up_off_alt</i>
                    </div>
                </div>
 
                {% if user.is_authenticated %}
                <div class="reply-box">
                    <div class="reply-header">
                        <p id="reply-text" class="hide-reply-text reply-text">Replying to @{{post.user}}</p>
                    </div>
                    <form method="POST" id="comment-form" style="width: 100%; margin-top:0;">
                        {% csrf_token %}
                        {{ form.content }}
                        <button class="submit-button" type="submit">
                            <i class="material-icons">send</i>
                        </button>
                        <input type="hidden" name="comment_answer_id" value="0">
                    </form>
                </div>
                {% endif %}

                <div class="commentaries">
                    {% for a_comment in comments %}
                    <hr>
                        {% with comment=a_comment.comment %}
                        {% include 'commentBox.html' with username=comment.user date=comment.date title=comment.content type="false" id="false" post_id="false" %}

                        <div class="buttons">
                            <button class="replies-button" data-target="{{ comment.id }}" onclick="toggleReplies(this)">
                                Responses
                                <i onclick="toggleIcon(this)" class="material-icons">expand_more</i>
                            </button>

                            <button class="makeReply-button" data-target="{{ comment.id }}" onclick="toggleMakeReply(this)">
                                <i class="material-icons" style="margin-right: 10px;">reply</i>
                                Reply
                            </button>
                        </div>

                        <div class="buttons-functionalities">
                            <form method="POST" class="hidden-makeReply" data-comment-id="{{ comment.id }}" style="width: 100%; margin-top:0; display:none;">
                                {% csrf_token %}
                                {{ form.content }}
                                <button class="submit-button" type="submit">
                                    <i class="material-icons">send</i>
                                </button>
                                <input type="hidden" name="comment_answer_id" value="{{ comment.id }}">
                            </form> 
                            
                            <div class="hidden-replies" style="display: none;" data-comment-id="{{ comment.id }}">
                            {% for reply in a_comment.replies %}
                            {% include 'commentBox.html' with username=reply.user date=reply.date title=reply.content type="false" id="false" post_id="false" %}
                            {% endfor %}
                            </div>
                        </div>

                        {% endwith %}
                    {% endfor %}
                    <hr>
                </div>

            </div>
        </div>

        <script>
            function toggleThumb(x) {
               if (x.textContent === 'thumb_up_off_alt') {
                   x.textContent = 'thumb_up';
               } else {
                   x.textContent = 'thumb_up_off_alt';
               }
            }

            document.getElementById('goBack').addEventListener('click', function() {
                window.history.back();
            });
 
            document.addEventListener('DOMContentLoaded', function () {
                const textarea = document.querySelector('#comment-form textarea');
                const replyText = document.getElementById('reply-text');

                textarea.addEventListener('click', function () {
                    replyText.classList.remove('hide-reply-text');
                });

                document.addEventListener('click', function (event) {
                    if (event.target !== textarea) {
                        replyText.classList.add('hide-reply-text');
                    }
                });
            });

            
            function toggleReplies(button) {
                const commentId = button.getAttribute('data-target');
                const repliesContainer = document.querySelector(`.hidden-replies[data-comment-id="${commentId}"]`);

                if (repliesContainer) {
                    if (repliesContainer.style.display === 'none' || repliesContainer.style.display === '') {
                        repliesContainer.style.display = 'block';
                    } else {
                        repliesContainer.style.display = 'none';
                    }
                }
            }

            function toggleMakeReply(button) {
                const commentId = button.getAttribute('data-target');
                const repliesContainer = document.querySelector(`.hidden-makeReply[data-comment-id="${commentId}"]`);

                if (repliesContainer) {
                    if (repliesContainer.style.display === 'none' || repliesContainer.style.display === '') {
                        repliesContainer.style.display = 'block';
                    } else {
                        repliesContainer.style.display = 'none';
                    }
                }
            }

            function toggleIcon(x) {
                if (x.textContent === 'expand_more') {
                    x.textContent = 'expand_less';
                } else {
                    x.textContent = 'expand_more';
                }
            }
       </script>
    </body>
</html>